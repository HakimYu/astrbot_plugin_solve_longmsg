# 长消息撤回转发插件

一个用于检测并处理长消息的 AstrBot 插件，当消息长度超过设定阈值时，会自动撤回原消息并以合并转发的形式重新发送。

## 功能特性

- 🔍 **智能检测**：自动检测超过长度阈值的消息
- 🗑️ **自动撤回**：撤回原消息避免刷屏
- 📤 **合并转发**：以合并转发形式重新发送长消息
- 🛡️ **异常处理**：完善的错误处理和恢复机制
- ⚙️ **灵活配置**：支持群组白名单和多种配置选项
- 🔄 **重试机制**：网络异常时自动重试操作
- 📝 **备选方案**：转发失败时发送预览消息

## 配置选项

### 基础配置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `max_length` | int | 100 | 触发合并转发的消息长度阈值 |
| `group_whitelist` | list | [] | 群白名单，为空则处理所有群 |

### 高级配置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `enable_fallback` | bool | true | 启用备选消息机制 |
| `fallback_preview_length` | int | 100 | 备选消息预览长度 |
| `enable_logging` | bool | true | 启用详细日志记录 |
| `retry_count` | int | 2 | 操作重试次数 |
| `retry_delay` | float | 1.0 | 重试延迟（秒） |

## 配置示例

```json
{
  "max_length": 150,
  "group_whitelist": [123456789, 987654321],
  "enable_fallback": true,
  "fallback_preview_length": 80,
  "enable_logging": true,
  "retry_count": 3,
  "retry_delay": 0.5
}
```

## 工作原理

1. **消息检测**：监听群消息，检查消息长度是否超过阈值
2. **群组过滤**：如果设置了白名单，只处理指定群的消息
3. **撤回原消息**：尝试撤回超过长度的原消息
4. **合并转发**：创建合并转发节点，重新发送消息
5. **错误处理**：如果转发失败，发送备选预览消息
6. **重试机制**：网络异常时自动重试操作

## 异常处理

### 配置验证
- 自动验证配置参数的有效性
- 无效配置自动使用默认值
- 详细的配置错误日志

### 操作重试
- 撤回消息失败时自动重试
- 可配置重试次数和延迟时间
- 重试失败后继续执行后续操作

### 错误恢复
- 转发失败时发送备选消息
- 确保用户能看到消息内容
- 详细的错误日志记录

## 日志记录

插件提供详细的日志记录，包括：
- 插件初始化和配置信息
- 长消息检测和处理过程
- 撤回和转发操作结果
- 错误和异常信息
- 重试操作详情

可通过 `enable_logging` 配置项控制日志输出。

## 兼容性

- 支持 aiocqhttp 平台
- 兼容 AstrBot 框架
- 支持多种消息类型

## 注意事项

1. **权限要求**：机器人需要撤回消息的权限
2. **群组设置**：确保机器人在目标群中有足够权限
3. **网络环境**：建议在网络稳定的环境下使用
4. **配置调整**：根据实际需求调整消息长度阈值

## 故障排除

### 常见问题

1. **消息无法撤回**
   - 检查机器人权限
   - 确认消息发送时间（可能超过撤回时限）
   - 查看日志中的错误信息

2. **转发消息失败**
   - 检查网络连接
   - 确认群组设置
   - 查看重试日志

3. **配置不生效**
   - 重启插件
   - 检查配置文件格式
   - 查看配置验证日志

### 调试建议

1. 启用详细日志记录
2. 检查机器人权限设置
3. 测试不同长度的消息
4. 监控网络连接状态

## 更新日志

### v1.0.0
- 初始版本发布
- 基础的长消息检测和转发功能
- 完善的异常处理机制
- 灵活的配置选项

## 许可证

MIT License

## 作者

HakimYu

## 仓库地址

https://github.com/HakimYu/revoke-resend-long-msg